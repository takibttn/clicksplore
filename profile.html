<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Profile - Clicksplore</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="/config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- REMOVED language.js import, will use inline or LanguageManager from parent/shared -->
  
  <script>
    // Load environment variables - MUST BE FIRST (Consistent with test3.html)
    // In a real build step these would be replaced, for now we use the same fallbacks
    const __cfg = window.__APP_CONFIG__ || {};
    const SUPABASE_URL = __cfg.SUPABASE_URL;
    const SUPABASE_ANON_KEY = __cfg.SUPABASE_ANON_KEY;
    const API_BASE_CONFIG = __cfg.API_BASE; // Production URL

    if (!SUPABASE_URL || !SUPABASE_ANON_KEY || !API_BASE_CONFIG) {
      throw new Error('Missing runtime config. Ensure /config.js is available and env vars are set.');
    }

    // Initialize Supabase client
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Make it globally available
    window.supabase = supabaseClient;
  </script>

  <style>
    :root{
      --hot:#ff00ff;--indigo:#08003d;--violet:#8c00ff;
      --glass-1:rgba(11,8,32,.78);--glass-2:rgba(11,8,32,.64);
      --white:#ffffff;--text:#eef0ff;--muted:rgba(255,255,255,.8);
      --line:rgba(255,255,255,.16);--line-2:rgba(255,255,255,.22);
      --success:#28a745; --danger:#dc3545; --warning:#ffb703;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:'Inter',system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      line-height:1.55;color:var(--text);
      background: radial-gradient(1200px 800px at 10% 10%, rgba(255,0,255,.15), transparent 60%),
                  radial-gradient(1000px 700px at 90% 20%, rgba(140,0,255,.15), transparent 60%),
                  linear-gradient(135deg,var(--hot) 0%, var(--indigo) 100%);
      background-attachment: fixed;overflow-x:hidden;
    }
    body:before{content:"";position:fixed;inset:0;pointer-events:none;
      background: conic-gradient(from 180deg at 70% -20%, rgba(255,255,255,.08), rgba(0,0,0,0) 40%),
                  radial-gradient(800px 300px at 50% -5%, rgba(255,255,255,.08), transparent 60%);
      mix-blend-mode: screen;opacity:.8}

    /* Top notice (optional ad/announcement bar) */
    .ad-space{background:rgba(255,255,255,.06);border-bottom:1px solid var(--line);backdrop-filter:blur(8px);padding:12px 16px;text-align:center}
    .ad-space .ad-placeholder{color:var(--muted);font-size:.85rem;letter-spacing:.08em;text-transform:uppercase;position:relative;display:inline-block}
    .ad-space .ad-placeholder:after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.18),transparent);animation:shimmer 2.8s infinite}

    /* Navigation */
    nav{position:fixed;top:0;left:0;right:0;z-index:1000;padding:18px 0;transition:.25s ease;
      background:rgba(8,0,61,.18);backdrop-filter:blur(14px);border-bottom:1px solid transparent}
    nav.scrolled{background:rgba(8,0,61,.6);border-color:var(--line)}
    .nav-container{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:0 20px;gap:16px}
    .logo{font-size:1.6rem;font-weight:900;letter-spacing:.3px;text-decoration:none;background:linear-gradient(45deg,var(--hot),#9b5cff);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .nav-links{list-style:none;display:flex;gap:26px}
    .nav-links a{color:var(--text);text-decoration:none;position:relative}
    .nav-links a:after{content:"";position:absolute;left:0;bottom:-6px;height:2px;width:0;background:linear-gradient(90deg,var(--hot),#9b5cff);transition:width .25s}
    .nav-links a:hover:after{width:100%}
    .icon-btn{position:relative;border:1px solid var(--line);background:rgba(255,255,255,.06);backdrop-filter:blur(8px);color:var(--text);font-size:1.05rem;padding:10px;border-radius:50%;cursor:pointer;transition:transform .2s, background .2s, border-color .2s;display:grid;place-items:center}
    .icon-btn:hover{transform:translateY(-2px) scale(1.05);background:rgba(255,255,255,.12);border-color:var(--line-2)}

    /* Profile Container */
    .profile-container{max-width:1200px;margin:120px auto 40px;padding:0 20px}

    /* Header */
    .profile-header{
      background:var(--glass-1);border:1px solid var(--line);border-radius:20px;
      padding:40px;margin-bottom:30px;box-shadow:0 24px 60px rgba(0,0,0,.35);
      position:relative;color:var(--text);overflow:hidden
    }
    .profile-header::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(45deg,var(--hot),#9b5cff)}
    .profile-info{display:flex;align-items:center;gap:30px;margin-bottom:30px}
    .profile-avatar{width:120px;height:120px;border-radius:50%;background:linear-gradient(135deg,var(--hot),#7a5cff);
      display:flex;align-items:center;justify-content:center;color:#fff;font-size:3rem;font-weight:800;
      box-shadow:0 10px 30px rgba(122,92,255,.35);position:relative;cursor:pointer;transition:.3s}
    .profile-avatar:hover{transform:scale(1.05)}
    .avatar-upload{position:absolute;bottom:0;right:0;width:35px;height:35px;background:#ff5b8a;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;border:3px solid #fff;font-size:.9rem}
    .profile-details h1{font-size:2.5rem;font-weight:900;margin-bottom:10px;color:#fff}
    .profile-details p{color:var(--muted);font-size:1.05rem;margin-bottom:6px}
    .member-since{display:flex;align-items:center;gap:8px;color:#ffd26f;font-weight:700;margin-top:12px}

    /* Stats */
    .profile-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px}
    .stat-card{background:var(--glass-2);border:1px solid var(--line);border-radius:15px;padding:20px;text-align:center;transition:.2s}
    .stat-card:hover{transform:translateY(-5px)}
    .stat-number{font-size:2rem;font-weight:900;color:#fff;margin-bottom:5px}
    .stat-label{opacity:.85;font-size:.9rem}

    .credits-card{background:linear-gradient(135deg,#28a745,#20c997);color:#fff;border:none}

    /* Tabs */
    .profile-tabs{display:flex;gap:10px;margin-bottom:30px;overflow-x:auto;padding-bottom:5px}
    .tab-btn{background:var(--glass-2);border:1px solid var(--line);color:var(--text);padding:12px 24px;border-radius:999px;cursor:pointer;transition:.2s;font-weight:700;display:flex;align-items:center;gap:8px;white-space:nowrap}
    .tab-btn.active,.tab-btn:hover{background:linear-gradient(135deg,var(--hot),#7a5cff);color:#fff;border-color:transparent;transform:translateY(-2px)}

    /* Cards & Sections */
    .tab-content{display:none;background:var(--glass-1);border:1px solid var(--line);border-radius:20px;padding:40px;box-shadow:0 20px 60px rgba(0,0,0,.25)}
    .tab-content.active{display:block;animation:fadeIn .3s ease}
    .subscriptions-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px;margin-bottom:30px}
    .subscription-card,.order-card,.ticket-card{background:var(--glass-2);border:1px solid var(--line);border-radius:15px;padding:25px;box-shadow:0 10px 30px rgba(0,0,0,.3);transition:.2s}
    .subscription-card:hover,.order-card:hover,.ticket-card:hover{transform:translateY(-5px)}
    .subscription-header{display:flex;align-items:center;gap:15px;margin-bottom:20px}
    .subscription-icon{width:50px;height:50px;border-radius:10px;background:linear-gradient(135deg,#7a5cff,#b05cff);display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.5rem}
    .subscription-info h3{font-size:1.2rem;font-weight:700;color:#fff;margin-bottom:5px}
    .subscription-price{color:#ffd26f;font-weight:700}
    .subscription-status{display:flex;align-items:center;gap:10px;margin-bottom:12px}
    .status-badge{padding:4px 12px;border-radius:15px;font-size:.8rem;font-weight:800}
    .status-active{background:rgba(40,167,69,.2);color:#28a745}
    .status-expired{background:rgba(220,53,69,.2);color:#dc3545}
    .detail-row{display:flex;justify-content:space-between;margin-bottom:8px;color:var(--muted)}

    .action-btn{flex:1;padding:10px 14px;border:none;border-radius:10px;background:linear-gradient(135deg,var(--hot),#7a5cff);color:#fff;font-weight:800;cursor:pointer}
    .btn-secondary{background:rgba(255,255,255,.08);border:1px solid var(--line);color:#fff}

    /* Forms */
    .form-group{margin-bottom:20px}
    .form-label{display:block;margin-bottom:8px;font-weight:800}
    .form-input{width:100%;padding:12px 16px;border:2px solid var(--line);border-radius:10px;background:var(--glass-2);color:#fff}
    .form-input:focus{outline:none;border-color:#7a5cff}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    .save-btn{background:linear-gradient(135deg,var(--hot),#7a5cff);color:#fff;border:none;border-radius:10px;padding:12px 20px;font-weight:800;cursor:pointer}

    /* Empty state */
    .empty-state{text-align:center;padding:60px 20px;color:var(--muted)}
    .empty-state i{font-size:3rem;margin-bottom:14px;opacity:.7}
    .cta-btn{display:inline-block;background:linear-gradient(135deg,var(--hot),#7a5cff);color:#fff;padding:12px 24px;border-radius:25px;text-decoration:none;font-weight:800}

    /* Toast & Loading */
    .toast-message{position:fixed;bottom:30px;right:30px;background:#12101d;color:#fff;padding:15px 25px;border-radius:10px;z-index:3000;animation:slideUp .3s ease-out;box-shadow:0 10px 30px rgba(0,0,0,.4)}
    .toast-message.error{background:#dc3545}
    .toast-message.info{background:#17a2b8}
    .loading-spinner{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:3rem;color:#ffd26f;z-index:3500}

    /* Chat Button */
    .chat-btn{position:absolute;bottom:10px;right:10px;background:#ffd26f;color:#000;border:none;border-radius:999px;padding:10px 14px;cursor:pointer;transition:all .2s ease;box-shadow:0 8px 20px rgba(0,0,0,.25);display:flex;align-items:center;gap:10px;font-weight:800}
    .chat-btn:hover{transform:translateY(-1px);background:#ffda3d}
    .chat-btn i{font-size:1.1rem}
    .chat-btn span{font-size:.9rem;letter-spacing:.2px}
    .credits-card{position:relative}

    /* Chat Modal */
    .chat-modal{width:min(500px,95vw);max-height:70vh}
    .chat-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--line)}
    .chat-header-actions{display:flex;align-items:center;gap:10px}
    .chat-header h3{margin:0;font-size:1.2rem}
    .modal-close{background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;padding:0;width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:4px;transition:background .2s}
    .modal-close:hover{background:rgba(255,255,255,.1)}
    .chat-messages{height:300px;overflow-y:auto;padding:12px;background:rgba(0,0,0,.2);border-radius:8px;margin-bottom:12px}
    .chat-message{margin-bottom:12px}
    .chat-message.admin{align-self:flex-start}
    .chat-message.user{align-self:flex-end}
    .chat-bubble{max-width:80%;padding:8px 12px;border-radius:12px;word-wrap:break-word}
    .chat-message.admin .chat-bubble{background:rgba(255,255,255,.1);color:#fff}
    .chat-message.user .chat-bubble{background:#ffd26f;color:#000}
    .chat-time{font-size:.75rem;opacity:.6;margin-top:4px}
    .chat-input-area{display:flex;gap:8px}
    .chat-input-area input{flex:1;padding:10px;border-radius:6px;border:1px solid var(--line);background:rgba(255,255,255,.05);color:#fff}
    .chat-input-area input::placeholder{color:rgba(255,255,255,.5)}
    .send-btn{padding:10px 12px;background:#ffd26f;color:#000;border:none;border-radius:6px;cursor:pointer;transition:background .2s}
    .send-btn:hover{background:#ffda3d}
    .chat-help-btn{position:relative;display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);color:#ffd26f;cursor:help;transition:all .2s}
    .chat-help-btn:hover{background:rgba(255,255,255,.12);border-color:rgba(255,255,255,.25)}
    .chat-help-tooltip{position:absolute;right:0;top:calc(100% + 10px);min-width:260px;max-width:320px;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(20,20,28,.92);color:rgba(255,255,255,.92);font-size:.85rem;line-height:1.35;box-shadow:0 20px 50px rgba(0,0,0,.45);opacity:0;visibility:hidden;transform:translateY(-4px);transition:opacity .15s, transform .15s, visibility .15s;z-index:5}
    .chat-help-btn:hover .chat-help-tooltip{opacity:1;visibility:visible;transform:translateY(0)}
    .chat-help-tooltip:before{content:"";position:absolute;right:10px;top:-6px;width:10px;height:10px;background:rgba(20,20,28,.92);border-left:1px solid rgba(255,255,255,.14);border-top:1px solid rgba(255,255,255,.14);transform:rotate(45deg)}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(6px);z-index:3200;display:none}
    .modal.show{display:block}
    .modal-card{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:var(--glass-1);color:#fff;border:1px solid var(--line);border-radius:18px;padding:28px;width:min(480px,92vw);box-shadow:0 24px 60px rgba(0,0,0,.3)}

    @keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

    @media (max-width: 768px){
      .nav-links{display:none}
      .profile-container{margin-top:100px}
      .profile-info{flex-direction:column;text-align:center;gap:20px}
      .profile-avatar{width:100px;height:100px;font-size:2.5rem}
      .profile-details h1{font-size:2rem}
      .profile-stats{grid-template-columns:repeat(2,1fr);gap:15px}
      .tab-content{padding:26px}
      .subscriptions-grid{grid-template-columns:1fr}
      .form-row{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav id="navbar">
    <div class="nav-container">
      <a href="test3.html" class="logo">Clicksplore</a>
      <ul class="nav-links">
        <li><a href="test3.html">Home</a></li>
        <li><a href="services.html">Services</a></li>
        <li><a href="#how-it-works">How it Works</a></li>
        <li><a href="contact.html">Contact</a></li>
      </ul>

      <div style="display:flex;align-items:center;gap:12px;">
        <button class="icon-btn" onclick="window.location.href='test3.html'"><i class="fas fa-home"></i></button>
        <button onclick="openChatModal()" class="save-btn" style="padding:10px 16px;border-radius:999px;background:#ffd26f;color:#000;">
          <i class="fas fa-dollar-sign"></i> Buy Credits
        </button>
        <button onclick="logout()" class="save-btn" style="padding:10px 16px;border-radius:999px;">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>
  </nav>

  <div class="profile-container">
    <!-- Profile Header -->
    <div class="profile-header">
      <div class="profile-info">
        <div class="profile-avatar" onclick="changeAvatar()">
          <span id="avatarInitial">U</span>
          <div class="avatar-upload"><i class="fas fa-camera"></i></div>
        </div>
        <div class="profile-details">
          <h1 id="userName">Loading...</h1>
          <p id="userEmail">Loading...</p>
          <p id="userLocation"><i class="fas fa-map-marker-alt"></i> <span id="locationText">Not specified</span></p>
          <div class="member-since"><i class="fas fa-calendar-alt"></i> <span id="memberSince">Loading...</span></div>
        </div>
      </div>

      <div class="profile-stats">
        <div class="stat-card">
          <div class="stat-number" id="activeSubscriptions">0</div>
          <div class="stat-label">Active Subscriptions</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalOrders">0</div>
          <div class="stat-label">Total Orders</div>
        </div>
        <div class="stat-card credits-card">
          <div class="stat-number" id="userCredits">$0.00</div>
          <div class="stat-label">Available Credits</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="supportTicketCount">0</div>
          <div class="stat-label">Open Tickets</div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="profile-tabs">
      <button class="tab-btn active" onclick="showTab(event,'subscriptions')">
        <i class="fas fa-play-circle"></i> My Subscriptions
      </button>
      <button class="tab-btn" onclick="showTab(event,'orders')">
        <i class="fas fa-receipt"></i> Order History
      </button>
      <button class="tab-btn" onclick="showTab(event,'support')">
        <i class="fas fa-life-ring"></i> Support Tickets
      </button>
      <button class="tab-btn" onclick="showTab(event,'profile-settings')">
        <i class="fas fa-user-edit"></i> Profile Settings
      </button>
      <button class="tab-btn" onclick="showTab(event,'account-settings')">
        <i class="fas fa-cog"></i> Account Settings
      </button>
    </div>

    <!-- Tab Content: My Subscriptions -->
    <div id="subscriptions" class="tab-content active">
      <h2 style="margin-bottom: 22px;">
        <i class="fas fa-play-circle" style="color:#ffd26f;"></i> My Active Subscriptions
      </h2>

      <div class="subscriptions-grid" id="subscriptionsGrid"></div>

      <div id="noSubscriptions" class="empty-state" style="display:none;">
        <i class="fas fa-play-circle"></i>
        <h3>No Active Subscriptions</h3>
        <p>You don't have any active subscriptions yet. Browse our services to get started!</p>
        <a href="test3.html" class="cta-btn"><i class="fas fa-plus"></i> Browse Services</a>
      </div>
    </div>

    <!-- Tab Content: Order History -->
    <div id="orders" class="tab-content">
      <h2 style="margin-bottom: 22px;">
        <i class="fas fa-receipt" style="color:#ffd26f;"></i> Order History
      </h2>

      <div id="orderHistory"></div>

      <div id="noOrders" class="empty-state" style="display:none;">
        <i class="fas fa-receipt"></i>
        <h3>No Orders Yet</h3>
        <p>You haven't placed any orders yet. Start subscribing to services to see your order history here!</p>
        <a href="test3.html" class="cta-btn"><i class="fas fa-shopping-cart"></i> Start Shopping</a>
      </div>
    </div>

    <!-- Tab Content: Support Tickets -->
    <div id="support" class="tab-content">
      <h2 style="margin-bottom: 22px;">
        <i class="fas fa-life-ring" style="color:#ffd26f;"></i> Support Tickets
      </h2>

      <div style="margin-bottom: 20px;">
        <button onclick="createSupportTicket()" class="save-btn">
          <i class="fas fa-plus"></i> Create New Ticket
        </button>
      </div>

      <div id="supportTicketsList"></div>

      <div id="noTickets" class="empty-state" style="display:none;">
        <i class="fas fa-life-ring"></i>
        <h3>No Support Tickets</h3>
        <p>You don't have any support tickets. Need help? Create a new ticket!</p>
        <button onclick="createSupportTicket()" class="cta-btn"><i class="fas fa-plus"></i> Create Ticket</button>
      </div>
    </div>

    <!-- Tab Content: Profile Settings -->
    <div id="profile-settings" class="tab-content">
      <h2 style="margin-bottom: 22px;">
        <i class="fas fa-user-edit" style="color:#ffd26f;"></i> Profile Settings
      </h2>

      <form id="profileForm" onsubmit="saveProfile(event)">
        <div class="form-group">
          <label class="form-label">Full Name</label>
          <input type="text" class="form-input" id="fullName" required/>
        </div>

        <div class="form-group">
          <label class="form-label">Email Address</label>
          <input type="email" class="form-input" id="email" disabled/>
        </div>

        <div class="form-group">
          <label class="form-label">Phone Number</label>
          <input type="tel" class="form-input" id="phone" placeholder="Enter your phone number"/>
        </div>

        <div class="form-group">
          <label class="form-label">Billing Address (JSON)</label>
          <textarea class="form-input" id="billingAddress" rows="4" placeholder='{"street":"123 Main St","city":"New York","state":"NY","zip":"10001","country":"USA"}'></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Referral Code</label>
          <input type="text" class="form-input" id="referralCode" readonly/>
          <small style="color:var(--muted);margin-top:5px;display:block;">Share this code with friends to earn credits!</small>
        </div>

        <button type="submit" class="save-btn"><i class="fas fa-save"></i> Save Changes</button>
      </form>
    </div>

    <!-- Tab Content: Account Settings -->
    <div id="account-settings" class="tab-content">
      <h2 style="margin-bottom: 22px;">
        <i class="fas fa-cog" style="color:#ffd26f;"></i> Account Settings
      </h2>

      <div class="settings-section" style="margin-bottom:30px;border-bottom:1px solid var(--line);padding-bottom:20px;">
        <div class="section-title" style="font-weight:900;margin-bottom:12px;"><i class="fas fa-shield-alt"></i> Security Settings</div>

        <div class="form-group">
          <label class="form-label">Current Password</label>
          <input type="password" class="form-input" id="currentPassword" placeholder="Enter current password"/>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">New Password</label>
            <input type="password" class="form-input" id="newPassword" placeholder="Enter new password"/>
          </div>
          <div class="form-group">
            <label class="form-label">Confirm New Password</label>
            <input type="password" class="form-input" id="confirmPassword" placeholder="Confirm new password"/>
          </div>
        </div>

        <button onclick="changePassword()" class="save-btn" style="margin-bottom:10px;"><i class="fas fa-key"></i> Change Password</button>
      </div>

      <div class="settings-section" style="margin-bottom:30px;border-bottom:1px solid var(--line);padding-bottom:20px;">
        <div class="section-title" style="font-weight:900;margin-bottom:12px;"><i class="fas fa-user-friends"></i> Referral Program</div>

        <div style="background:rgba(255,255,255,.06);border:1px solid var(--line);padding:16px;border-radius:10px;">
          <h4 style="margin-bottom:8px;">Your Referral Statistics</h4>
          <div class="form-row">
            <div>
              <strong>Referral Code:</strong><br/>
              <span id="displayReferralCode" style="font-family:monospace;background:rgba(0,0,0,.35);padding:6px 10px;border-radius:6px;display:inline-block;margin-top:6px;">Loading...</span>
            </div>
            <div>
              <strong>People Referred:</strong><br/>
              <span id="referralCount" style="font-size:1.5rem;font-weight:900;color:#ffd26f;">0</span>
            </div>
          </div>
        </div>
      </div>

      <div class="settings-section">
        <div class="section-title" style="font-weight:900;margin-bottom:12px;">
          <i class="fas fa-trash-alt" style="color:#dc3545;"></i> Danger Zone
        </div>

        <div style="background:rgba(220,53,69,.08);border:1px solid rgba(220,53,69,.35);padding:16px;border-radius:10px;">
          <h4 style="color:#ff6b6b;margin-bottom:8px;">Delete Account</h4>
          <p style="color:var(--muted);margin-bottom:14px;">Once you delete your account, there is no going back. All your subscriptions will be cancelled and your data will be permanently removed.</p>
          <button onclick="deleteAccount()" class="action-btn" style="background:linear-gradient(135deg,#ff6b6b,#ff984f);"><i class="fas fa-exclamation-triangle"></i> Delete Account</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Support Ticket Modal -->
  <div id="ticketModal" class="modal">
    <div class="modal-card">
      <h3 style="margin-bottom: 16px;">Create Support Ticket</h3>

      <form id="ticketForm" onsubmit="submitSupportTicket(event)">
        <div class="form-group">
          <label class="form-label">Subject</label>
          <input type="text" class="form-input" id="ticketSubject" required/>
        </div>

        <div class="form-group">
          <label class="form-label">Related Subscription (Optional)</label>
          <select class="form-input" id="ticketSubscription">
            <option value="">Select a subscription...</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Message</label>
          <textarea class="form-input" id="ticketMessage" rows="5" required placeholder="Describe your issue in detail..."></textarea>
        </div>

        <div style="display:flex;gap:10px;justify-content:flex-end;">
          <button type="button" onclick="closeTicketModal()" class="action-btn btn-secondary">Cancel</button>
          <button type="submit" class="action-btn">Create Ticket</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div class="loading-spinner" id="loadingSpinner">
    <i class="fas fa-spinner fa-spin"></i>
  </div>

<script>
  // ===== Server API Endpoints =====
  // Use API_BASE_CONFIG from top of file instead of window.location.origin
  // This ensures it works both locally (if configured) and in production
  const API_BASE = (window.location.protocol === 'file:') ? 'http://localhost:3000' : API_BASE_CONFIG;

  async function buildAuthHeaders(extra = {}) {
    const headers = { ...extra };
    try {
      const { data } = await window.supabase.auth.getSession();
      const token = data?.session?.access_token;
      if (token) headers.Authorization = `Bearer ${token}`;
    } catch (e) {
      // ignore
    }
    return headers;
  }

  // Supabase client is already initialized in the head script as window.supabase
  // But we keep this local reference for existing code compatibility
  // const supabaseClient = ... (Already initialized above)
    
let currentUser = null;
let userProfile = null;
let __subscriptions = []; // cache for modal dropdown
let __orders = []; // cache for orders
let __tickets = []; // cache for support tickets

let pageInitPromise = null;

document.addEventListener('DOMContentLoaded', function () {
  pageInitPromise = initializePage();
  pageInitPromise.finally(() => {
    setupEventListeners();
  });
});

// ===== Initialization =====
async function initializePage() {
  try {
    showLoading();

    // Check if user is authenticated - use API_BASE
    const res = await fetch(`${API_BASE}/api/profile`, { 
      method: 'GET', 
      credentials: 'include',
      headers: await buildAuthHeaders({ 'Accept': 'application/json', 'Content-Type': 'application/json' })
    });
    
    if (res.ok) {
      const { user, profile } = await res.json();
      currentUser = user;
      userProfile = profile;
      updateUserInterface();
      initCreditsRealtime();
      await Promise.all([
        loadUserSubscriptions(),
        loadUserOrders(),
        loadSupportTickets(),
      ]);
    } else {
      showToast('Please log in to view your profile', 'error');
      // Redirect to main page via absolute or relative path
      setTimeout(() => { window.location.href = 'test3.html'; }, 1200);
    }
  } catch (error) {
    console.error('Error initializing page:', error);
    showToast('Error loading profile', 'error');
  } finally {
    hideLoading();
  }
}

function updateUserInterface() {
  if (!currentUser) return;
  
  const email = currentUser.email;
  const fullName = userProfile?.full_name || currentUser.user_metadata?.full_name || 'User';
  const createdAt = userProfile?.created_at || currentUser.created_at;
  const credits = userProfile?.credits || 0;
  const referralCode = userProfile?.referral_code || 'Not generated';
  const phone = userProfile?.phone || '';

  document.getElementById('userName').textContent = fullName;
  document.getElementById('userEmail').textContent = email;
  document.getElementById('avatarInitial').textContent = fullName.charAt(0).toUpperCase();
  document.getElementById('userCredits').textContent = `$${credits.toFixed(2)}`;

  const memberDate = new Date(createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
  document.getElementById('memberSince').textContent = `Member since ${memberDate}`;

  document.getElementById('fullName').value = fullName;
  document.getElementById('email').value = email;
  document.getElementById('phone').value = phone;
  document.getElementById('referralCode').value = referralCode;
  document.getElementById('displayReferralCode').textContent = referralCode;

  if (userProfile?.billing_address) {
    document.getElementById('billingAddress').value = JSON.stringify(userProfile.billing_address, null, 2);
  }
}

// ===== Subscriptions =====
async function loadUserSubscriptions() {
  try {
    // Use API endpoint instead of direct Supabase query
    const res = await fetch(`${API_BASE}/api/user-subscriptions`, {
      method: 'GET',
      credentials: 'include',
      headers: await buildAuthHeaders({ 'Accept': 'application/json' })
    });
    
    if (!res.ok) {
      const errText = await res.text().catch(() => 'No error details');
      console.error('Failed to load subscriptions. Status:', res.status, 'Error:', errText);
      return;
    }

    const subscriptions = await res.json();

    __subscriptions = subscriptions || [];
    displaySubscriptions(__subscriptions);
    document.getElementById('activeSubscriptions').textContent =
      (__subscriptions).filter(sub => (sub.status || '').toLowerCase() === 'active').length;

    // Populate modal dropdown options
    const sel = document.getElementById('ticketSubscription');
    sel.innerHTML = '<option value="">Select a subscription...</option>';
    __subscriptions.forEach(s => {
      const name = s.subscription_services?.name || 'Service';
      const opt = document.createElement('option');
      opt.value = s.id;
      opt.textContent = `${name} (#${s.id})`;
      sel.appendChild(opt);
    });
  } catch (error) {
    console.error('Error loading subscriptions:', error);
  }
}

function displaySubscriptions(subscriptions) {
  const container = document.getElementById('subscriptionsGrid');
  const noSubs = document.getElementById('noSubscriptions');

  if (!subscriptions || subscriptions.length === 0) {
    container.innerHTML = '';
    noSubs.style.display = 'block';
    return;
  }

  noSubs.style.display = 'none';
  container.innerHTML = subscriptions.map(sub => createSubscriptionCard(sub)).join('');
}

function createSubscriptionCard(subscription) {
  // Fix: Handle potentially missing nested objects safely
  const service = subscription.subscription_services || {};
  const account = subscription.shared_accounts;
  const isActive = (subscription.status || '').toLowerCase() === 'active';
  const statusClass = isActive ? 'status-active' : 'status-expired';
  // Capitalize first letter
  const statusText = subscription.status ? 
    subscription.status.charAt(0).toUpperCase() + subscription.status.slice(1) : 'Unknown';
  const statusIcon = isActive ? 'check-circle' : 'exclamation-triangle';

  const endDate = subscription.end_date ? new Date(subscription.end_date).toLocaleDateString() : 'N/A';
  const renewalDate = subscription.renewal_date ? new Date(subscription.renewal_date).toLocaleDateString() : 'N/A';
  
  // Format price safely
  const price = subscription.payment_amount ? Number(subscription.payment_amount).toFixed(2) : '0.00';

  return `
    <div class="subscription-card">
      <div class="subscription-header">
        <div class="subscription-icon"><i class="fas fa-play"></i></div>
        <div class="subscription-info">
          <h3>${service.name || 'Unknown Service'}</h3>
          <div class="subscription-price">$${price}/month</div>
        </div>
      </div>

      <div class="subscription-status">
        <div class="status-badge ${statusClass}">${statusText}</div>
        <span style="color:var(--muted);font-size:.9rem;">${account ? 'Shared Account' : 'Private Account'}</span>
      </div>

      <div class="subscription-details">
        ${subscription.end_date ? `<div class="detail-row"><span>End Date:</span><span>${endDate}</span></div>` : ''}
        ${subscription.renewal_date ? `<div class="detail-row"><span>Next Renewal:</span><span>${renewalDate}</span></div>` : ''}
        ${account ? `<div class="detail-row"><span>Account Slots:</span><span>${account.current_users}/${account.max_users} used</span></div>` : ''}
        <div class="detail-row"><span>Started:</span><span>${new Date(subscription.start_date).toLocaleDateString()}</span></div>
      </div>

      <div class="subscription-actions" style="display:flex;gap:10px;margin-top:16px;">
        <button class="action-btn btn-secondary" onclick="manageSubscription('${subscription.id}')">
          <i class="fas fa-cog"></i> Manage
        </button>
        ${isActive ? `
        <button class="action-btn" onclick="cancelSubscription('${subscription.id}')" style="background:linear-gradient(135deg,#dc3545,#ff6b6b);">
          <i class="fas fa-times"></i> Cancel
        </button>` : ''}
      </div>
    </div>
  `;
}

// ===== Orders =====
async function loadUserOrders() {
  try {
    const res = await fetch(`${API_BASE}/api/orders`, {
      method: 'GET',
      credentials: 'include',
      headers: await buildAuthHeaders({ 'Accept': 'application/json' })
    });
    
    if (res.ok) {
      const orders = await res.json();
      __orders = orders;
      displayOrders(orders);
      document.getElementById('totalOrders').textContent = orders.length;
    } else {
      console.error('Failed to load orders');
    }
  } catch (error) {
    console.error('Error loading orders:', error);
  }
}

function displayOrders(orders) {
  const container = document.getElementById('orderHistory');
  const noOrders = document.getElementById('noOrders');

  if (!orders || orders.length === 0) {
    container.innerHTML = '';
    noOrders.style.display = 'block';
    return;
  }

  noOrders.style.display = 'none';
  container.innerHTML = orders.map(order => createOrderCard(order)).join('');
}

function createOrderCard(order) {
  const orderDate = new Date(order.created_at).toLocaleDateString();
  const statusClass = order.payment_status === 'completed' ? 'status-active' : 
                     order.payment_status === 'pending' ? 'status-expired' : 'status-expired';
  const statusText = order.payment_status.charAt(0).toUpperCase() + order.payment_status.slice(1);

  return `
    <div class="order-card" style="margin-bottom:20px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <h3>Order #${order.id}</h3>
        <div class="status-badge ${statusClass}">${statusText}</div>
      </div>
      
      <div class="detail-row">
        <span>Date:</span>
        <span>${orderDate}</span>
      </div>
      
      <div class="detail-row">
        <span>Total Amount:</span>
        <span>$${order.total_amount}</span>
      </div>
      
      <div class="detail-row">
        <span>Payment Method:</span>
        <span>${order.payment_method || 'N/A'}</span>
      </div>
      
      ${order.promo_code ? `
      <div class="detail-row">
        <span>Promo Code:</span>
        <span>${order.promo_code} ($${order.discount_amount || 0} off)</span>
      </div>` : ''}
      
      <button class="action-btn btn-secondary" style="margin-top:12px;" onclick="viewOrderDetails(${order.id})">
        <i class="fas fa-eye"></i> View Details
      </button>
    </div>
  `;
}

// ===== Support Tickets =====
async function loadSupportTickets() {
  try {
    const res = await fetch(`${API_BASE}/api/support-tickets`, {
      method: 'GET',
      credentials: 'include',
      headers: await buildAuthHeaders({ 'Accept': 'application/json' })
    });
    
    if (res.ok) {
      const tickets = await res.json();
      __tickets = tickets;
      displaySupportTickets(tickets);
      document.getElementById('supportTicketCount').textContent = 
        tickets.filter(t => t.status === 'open').length;
    } else {
      console.error('Failed to load support tickets');
    }
  } catch (error) {
    console.error('Error loading support tickets:', error);
  }
}

function displaySupportTickets(tickets) {
  const container = document.getElementById('supportTicketsList');
  const noTickets = document.getElementById('noTickets');

  if (!tickets || tickets.length === 0) {
    container.innerHTML = '';
    noTickets.style.display = 'block';
    return;
  }

  noTickets.style.display = 'none';
  container.innerHTML = tickets.map(ticket => createTicketCard(ticket)).join('');
}

function createTicketCard(ticket) {
  const createdDate = new Date(ticket.created_at).toLocaleDateString();
  const statusClass = ticket.status === 'open' ? 'status-active' : 
                     ticket.status === 'resolved' ? 'status-expired' : 'status-expired';
  const statusText = ticket.status.charAt(0).toUpperCase() + ticket.status.slice(1);

  return `
    <div class="ticket-card" style="margin-bottom:20px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <h3>${ticket.subject}</h3>
        <div class="status-badge ${statusClass}">${statusText}</div>
      </div>
      
      <div class="detail-row">
        <span>Created:</span>
        <span>${createdDate}</span>
      </div>
      
      <div class="detail-row">
        <span>Ticket ID:</span>
        <span>#${ticket.id}</span>
      </div>
      
      <p style="margin:12px 0;color:var(--muted);">${ticket.message.substring(0, 100)}...</p>
      
      <button class="action-btn btn-secondary" onclick="viewTicket(${ticket.id})">
        <i class="fas fa-eye"></i> View Ticket
      </button>
    </div>
  `;
}

// ===== Profile Management =====
async function saveProfile(event) {
  event.preventDefault();
  
  try {
    showLoading();
    
    const formData = {
      full_name: document.getElementById('fullName').value,
      phone: document.getElementById('phone').value,
    };
    
    // Parse billing address if provided
    const billingAddressText = document.getElementById('billingAddress').value;
    if (billingAddressText) {
      try {
        formData.billing_address = JSON.parse(billingAddressText);
      } catch (e) {
        showToast('Invalid JSON format for billing address', 'error');
        hideLoading();
        return;
      }
    }
    
    const res = await fetch(`${API_BASE}/api/profile`, {
      method: 'PUT',
      headers: await buildAuthHeaders({
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      }),
      credentials: 'include',
      body: JSON.stringify(formData)
    });
    
    if (res.ok) {
      const { profile } = await res.json();
      userProfile = profile;
      updateUserInterface();
      showToast('Profile updated successfully', 'success');
    } else {
      const error = await res.json();
      showToast(error.error || 'Failed to update profile', 'error');
    }
  } catch (error) {
    console.error('Error saving profile:', error);
    showToast('Error saving profile', 'error');
  } finally {
    hideLoading();
  }
}

async function changePassword() {
  const currentPassword = document.getElementById('currentPassword').value;
  const newPassword = document.getElementById('newPassword').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  
  if (!currentPassword || !newPassword || !confirmPassword) {
    showToast('Please fill in all password fields', 'error');
    return;
  }
  
  if (newPassword !== confirmPassword) {
    showToast('New passwords do not match', 'error');
    return;
  }
  
  if (newPassword.length < 6) {
    showToast('New password must be at least 6 characters', 'error');
    return;
  }
  
  try {
    showLoading();
    
    const res = await fetch(`${API_BASE}/api/change-password`, {
      method: 'POST',
      headers: await buildAuthHeaders({
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      }),
      credentials: 'include',
      body: JSON.stringify({
        currentPassword,
        newPassword
      })
    });
    
    if (res.ok) {
      showToast('Password changed successfully', 'success');
      // Clear password fields
      document.getElementById('currentPassword').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmPassword').value = '';
    } else {
      const error = await res.json();
      showToast(error.error || 'Failed to change password', 'error');
    }
  } catch (error) {
    console.error('Error changing password:', error);
    showToast('Error changing password', 'error');
  } finally {
    hideLoading();
  }
}

// ===== Support Ticket Functions =====
function createSupportTicket() {
  document.getElementById('ticketModal').classList.add('show');
}

function closeTicketModal() {
  document.getElementById('ticketModal').classList.remove('show');
  document.getElementById('ticketForm').reset();
}

async function submitSupportTicket(event) {
  event.preventDefault();
  
  try {
    showLoading();
    
    const formData = {
      subject: document.getElementById('ticketSubject').value,
      message: document.getElementById('ticketMessage').value,
      subscription_id: document.getElementById('ticketSubscription').value || null
    };
    
    const res = await fetch(`${API_BASE}/api/support-tickets`, {
      method: 'POST',
      headers: await buildAuthHeaders({
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      }),
      credentials: 'include',
      body: JSON.stringify(formData)
    });
    
    if (res.ok) {
      showToast('Support ticket created successfully', 'success');
      closeTicketModal();
      await loadSupportTickets(); // Refresh tickets list
    } else {
      const error = await res.json();
      showToast(error.error || 'Failed to create support ticket', 'error');
    }
  } catch (error) {
    console.error('Error creating support ticket:', error);
    showToast('Error creating support ticket', 'error');
  } finally {
    hideLoading();
  }
}

// ===== Account Management =====
async function deleteAccount() {
  const confirmed = confirm('Are you absolutely sure you want to delete your account? This action cannot be undone.');
  
  if (!confirmed) return;
  
  try {
    showLoading();
    
    const res = await fetch(`${API_BASE}/api/account`, {
      method: 'DELETE',
      credentials: 'include',
      headers: await buildAuthHeaders({ 'Accept': 'application/json' })
    });
    
    if (res.ok) {
      showToast('Account deleted successfully', 'success');
      setTimeout(() => {
        window.location.href = 'test3.html';
      }, 1500);
    } else {
      const error = await res.json();
      showToast(error.error || 'Failed to delete account', 'error');
    }
  } catch (error) {
    console.error('Error deleting account:', error);
    showToast('Error deleting account', 'error');
  } finally {
    hideLoading();
  }
}

// ===== UI Functions =====
function showTab(event, tabId) {
  // Update tab buttons
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.currentTarget.classList.add('active');
  
  // Update tab content
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });
  document.getElementById(tabId).classList.add('active');
}

function setupEventListeners() {
  // Navbar scroll effect
  window.addEventListener('scroll', () => {
    const navbar = document.getElementById('navbar');
    if (window.scrollY > 50) {
      navbar.classList.add('scrolled');
    } else {
      navbar.classList.remove('scrolled');
    }
  });
  
  // Close modal on outside click
  document.getElementById('ticketModal').addEventListener('click', (e) => {
    if (e.target.id === 'ticketModal') {
      closeTicketModal();
    }
  });
}

function showLoading() {
  document.getElementById('loadingSpinner').style.display = 'block';
}

function hideLoading() {
  document.getElementById('loadingSpinner').style.display = 'none';
}

function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `toast-message ${type}`;
  toast.textContent = message;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.remove();
  }, 4000);
}

function changeAvatar() {
  showToast('Avatar change functionality coming soon!', 'info');
}

// ===== COMPLETED FUNCTIONS =====

async function manageSubscription(subId) {
  try {
    showLoading();
    
    // Find the subscription
    const subscription = __subscriptions.find(s => s.id == subId);
    if (!subscription) {
      showToast('Subscription not found', 'error');
      return;
    }
    
    // Create a modal to show subscription details
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.innerHTML = `
      <div class="modal-card">
        <h3 style="margin-bottom: 16px;">Manage Subscription</h3>
        <div style="margin-bottom: 20px;">
          <h4>${subscription.subscription_services?.name || 'Unknown Service'}</h4>
          <p>Status: <span class="status-badge ${subscription.status === 'active' ? 'status-active' : 'status-expired'}">${subscription.status}</span></p>
          <p>Price: $${subscription.payment_amount}/month</p>
          <p>Start Date: ${new Date(subscription.start_date).toLocaleDateString()}</p>
          ${subscription.end_date ? `<p>End Date: ${new Date(subscription.end_date).toLocaleDateString()}</p>` : ''}
        </div>
        
        ${subscription.status === 'active' ? `
        <div style="margin-bottom: 20px;">
          <h4>Actions</h4>
          <button class="action-btn" onclick="cancelSubscription('${subscription.id}', true)" style="background:linear-gradient(135deg,#dc3545,#ff6b6b); margin-bottom: 10px;">
            <i class="fas fa-times"></i> Cancel Subscription
          </button>
          <button class="action-btn btn-secondary" onclick="renewSubscription('${subscription.id}')">
            <i class="fas fa-sync"></i> Renew Now
          </button>
        </div>
        ` : ''}
        
        <div style="display:flex;justify-content:flex-end;">
          <button class="action-btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // Close modal on outside click
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.remove();
      }
    });
    
  } catch (error) {
    console.error('Error managing subscription:', error);
    showToast('Error loading subscription details', 'error');
  } finally {
    hideLoading();
  }
}

async function cancelSubscription(subId, fromManage = false) {
  // Create confirmation modal
  const modal = document.createElement('div');
  modal.className = 'modal show';
  modal.innerHTML = `
    <div class="modal-card" style="max-width: 420px;">
      <div style="text-align: center; margin-bottom: 20px;">
        <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #dc3545, #ff6b6b); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
          <i class="fas fa-exclamation-triangle" style="font-size: 24px; color: white;"></i>
        </div>
        <h3 style="margin-bottom: 8px; color: #ff6b6b;">Cancel Subscription</h3>
        <p style="color: var(--muted); margin-bottom: 20px;">Are you sure you want to cancel this subscription? This action cannot be undone and you'll lose access to the service.</p>
      </div>
      
      <div style="display: flex; gap: 12px; justify-content: center;">
        <button onclick="this.closest('.modal').remove()" class="action-btn btn-secondary" style="flex: 1;">
          <i class="fas fa-times"></i> Keep Subscription
        </button>
        <button onclick="confirmCancelSubscription('${subId}', ${fromManage})" class="action-btn" style="flex: 1; background: linear-gradient(135deg, #dc3545, #ff6b6b);">
          <i class="fas fa-check"></i> Cancel Anyway
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Close modal on outside click
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  });
}

async function confirmCancelSubscription(subId, fromManage) {
  // Close the modal
  document.querySelector('.modal.show')?.remove();
  
  try {
    showLoading();
    
    const res = await fetch(`/api/subscriptions/${subId}/cancel`, {
      method: 'POST',
      credentials: 'include',
      headers: await buildAuthHeaders({ 'Accept': 'application/json' })
    });
    
    if (res.ok) {
      showToast('Subscription cancelled successfully', 'success');
      
      // Refresh subscriptions
      await loadUserSubscriptions();
      
      // Close modal if opened from manage
      if (fromManage) {
        document.querySelector('.modal.show')?.remove();
      }
    } else {
      const error = await res.json();
      showToast(error.error || 'Failed to cancel subscription', 'error');
    }
  } catch (error) {
    console.error('Error cancelling subscription:', error);
    showToast('Error cancelling subscription', 'error');
  } finally {
    hideLoading();
  }
}

async function renewSubscription(subId) {
  try {
    showLoading();
    
    const res = await fetch(`/api/subscriptions/${subId}/renew`, {
      method: 'POST',
      credentials: 'include',
      headers: await buildAuthHeaders({ 'Accept': 'application/json' })
    });
    
    if (res.ok) {
      showToast('Subscription renewed successfully', 'success');
      
      // Refresh subscriptions
      await loadUserSubscriptions();
      
      // Close modal
      document.querySelector('.modal.show')?.remove();
    } else {
      const error = await res.json();
      showToast(error.error || 'Failed to renew subscription', 'error');
    }
  } catch (error) {
    console.error('Error renewing subscription:', error);
    showToast('Error renewing subscription', 'error');
  } finally {
    hideLoading();
  }
}

async function viewOrderDetails(orderId) {
  try {
    showLoading();
    
    // Find the order
    const order = __orders.find(o => o.id == orderId);
    if (!order) {
      showToast('Order not found', 'error');
      return;
    }
    
    // Fetch order items
    const res = await fetch(`${API_BASE}/api/orders/${orderId}/items`, {
      method: 'GET',
      credentials: 'include',
      headers: await buildAuthHeaders({ 'Accept': 'application/json' })
    });
    
    let orderItems = [];
    if (res.ok) {
      orderItems = await res.json();
    }
    
    // Create a modal to show order details
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.innerHTML = `
      <div class="modal-card" style="max-width: 600px;">
        <h3 style="margin-bottom: 16px;">Order Details #${order.id}</h3>
        
        <div style="margin-bottom: 20px;">
          <div class="detail-row">
            <span>Order Date:</span>
            <span>${new Date(order.created_at).toLocaleDateString()}</span>
          </div>
          <div class="detail-row">
            <span>Total Amount:</span>
            <span>$${order.total_amount}</span>
          </div>
          <div class="detail-row">
            <span>Payment Status:</span>
            <span class="status-badge ${order.payment_status === 'completed' ? 'status-active' : 'status-expired'}">${order.payment_status}</span>
          </div>
          <div class="detail-row">
            <span>Payment Method:</span>
            <span>${order.payment_method || 'N/A'}</span>
          </div>
          ${order.promo_code ? `
          <div class="detail-row">
            <span>Promo Code:</span>
            <span>${order.promo_code} ($${order.discount_amount || 0} off)</span>
          </div>` : ''}
        </div>
        
        <h4 style="margin-bottom: 12px;">Order Items</h4>
        <div style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
          ${orderItems.length > 0 ? orderItems.map(item => `
            <div style="padding: 12px; border-bottom: 1px solid var(--line);">
              <div style="font-weight: bold;">${item.subscription_services?.name || 'Unknown Service'}</div>
              <div>Quantity: ${item.quantity}</div>
              <div>Duration: ${item.duration} month(s)</div>
              <div>Price: $${item.price}</div>
            </div>
          `).join('') : '<p>No items found for this order.</p>'}
        </div>
        
        <div style="display:flex;justify-content:flex-end;">
          <button class="action-btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // Close modal on outside click
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.remove();
      }
    });
    
  } catch (error) {
    console.error('Error viewing order details:', error);
    showToast('Error loading order details', 'error');
  } finally {
    hideLoading();
  }
}

async function viewTicket(ticketId) {
  try {
    showLoading();
    
    // Find the ticket
    const ticket = __tickets.find(t => t.id == ticketId);
    if (!ticket) {
      showToast('Ticket not found', 'error');
      return;
    }
    
    // Create a modal to show ticket details
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.innerHTML = `
      <div class="modal-card" style="max-width: 600px;">
        <h3 style="margin-bottom: 16px;">Support Ticket #${ticket.id}</h3>
        
        <div style="margin-bottom: 20px;">
          <div class="detail-row">
            <span>Subject:</span>
            <span>${ticket.subject}</span>
          </div>
          <div class="detail-row">
            <span>Status:</span>
            <span class="status-badge ${ticket.status === 'open' ? 'status-active' : 'status-expired'}">${ticket.status}</span>
          </div>
          <div class="detail-row">
            <span>Created:</span>
            <span>${new Date(ticket.created_at).toLocaleDateString()}</span>
          </div>
          ${ticket.resolved_at ? `
          <div class="detail-row">
            <span>Resolved:</span>
            <span>${new Date(ticket.resolved_at).toLocaleDateString()}</span>
          </div>` : ''}
        </div>
        
        <h4 style="margin-bottom: 12px;">Message</h4>
        <div style="padding: 16px; background: var(--glass-2); border-radius: 10px; margin-bottom: 20px;">
          <p>${ticket.message}</p>
        </div>
        
        <div style="display:flex;justify-content:flex-end;">
          <button class="action-btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // Close modal on outside click
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.remove();
      }
    });
    
  } catch (error) {
    console.error('Error viewing ticket:', error);
    showToast('Error loading ticket details', 'error');
  } finally {
    hideLoading();
  }
}

// ===== Logout Function =====
async function logout() {
  try {
    console.log('Starting logout...');
    // API_BASE is already defined at the top
    console.log('Logout URL:', `${API_BASE}/api/logout`);
    
    showLoading();
    
    // Try server logout but don't depend on it
    try {
      const response = await fetch(`${API_BASE}/api/logout`, { 
        method: 'POST', 
        credentials: 'include',
        headers: await buildAuthHeaders({
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        })
      });
      
      if (!response.ok) {
        console.warn('Logout request failed, but continuing with client cleanup');
      }
    } catch (serverError) {
      console.warn('Server logout failed:', serverError);
    }
    
    // Always clear client-side state regardless of server response
    currentUser = null;
    userProfile = null;
    
    // Clear user cookies (same as main page)
    document.cookie = 'click_token=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT';
    document.cookie = 'click_refresh=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT';
    document.cookie = 'click_user=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC; SameSite=Lax';
    document.cookie = 'click_remember=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC; SameSite=Lax';
    
    // Clear localStorage data
    localStorage.removeItem('click_cart');
    localStorage.removeItem('click_currency');
    
    // Clear Supabase session
    try {
      // Use the globally available client
      await window.supabase.auth.signOut();
    } catch (supabaseError) {
      console.warn('Supabase signout failed:', supabaseError);
    }
    
    showToast('Logged out successfully', 'success');
    hideLoading();
    
    // Redirect after a short delay
    setTimeout(() => {
      window.location.href = 'test3.html';
    }, 1000);
    
  } catch (error) {
    console.error('Error in logout process:', error);
    // Still try to clear client state even if everything fails
    currentUser = null;
    userProfile = null;
    document.cookie = 'click_token=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT';
    document.cookie = 'click_refresh=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT';
    document.cookie = 'click_user=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC; SameSite=Lax';
    document.cookie = 'click_remember=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC; SameSite=Lax';
    
    // Clear localStorage data
    localStorage.removeItem('click_cart');
    localStorage.removeItem('click_currency');
    
    // Clear Supabase session
    try {
      // Use the globally available client
      await window.supabase.auth.signOut();
    } catch (supabaseError) {
      console.warn('Supabase signout failed:', supabaseError);
    }
    
    showToast('Logged out (with errors)', 'warning');
    hideLoading();
    
    setTimeout(() => {
      window.location.href = 'test3.html';
    }, 1000);
  }
}

// ===== Chat Functions =====
let chatChannel = null;
let creditsChannel = null;
let seenClientMsgIds = new Set();

async function loadChatHistory() {
  const container = document.getElementById('chatMessages');
  if (!container) return;

  if (!currentUser?.id) {
    console.log('No current user, cannot load chat history');
    return;
  }

  try {
    // Use global supabase instance
    const { data, error } = await window.supabase
      .from('chat_messages')
      .select('*')
      .or(`from_user_id.eq.${currentUser.id},to_user_id.eq.${currentUser.id}`)
      .order('ts', { ascending: true });

    if (error) {
      console.error('Error loading chat history:', error);
      return;
    }

    if (!data || data.length === 0) {
      console.log('No chat history found');
      return;
    }

    container.innerHTML = '';
    for (const msg of data) {
      if (msg?.client_msg_id) seenClientMsgIds.add(msg.client_msg_id);
      displayChatMessage({
        fromRole: msg.from_role,
        fromUserId: msg.from_user_id,
        toUserId: msg.to_user_id,
        text: msg.text,
        ts: msg.ts,
        clientMsgId: msg.client_msg_id
      }, true);
    }

    console.log(`Loaded ${data.length} messages from chat history`);
  } catch (error) {
    console.error('Error loading chat history:', error);
  }
}

async function saveChatMessage(msg) {
  if (!currentUser?.id) {
    console.log('No current user, cannot save message');
    return;
  }

  try {
    // Use global supabase instance
    const { error } = await window.supabase
      .from('chat_messages')
      .insert({
        from_user_id: currentUser.id,
        to_user_id: msg.toUserId || null,
        from_role: msg.fromRole,
        to_role: msg.toRole || 'admin',
        text: msg.text,
        ts: new Date(msg.ts).toISOString(),
        client_msg_id: msg.clientMsgId || null
      });

    if (error) {
      console.error('Error saving chat message:', error);
    } else {
      console.log('Chat message saved to database');
    }
  } catch (error) {
    console.error('Error saving chat message:', error);
  }
}

async function saveIncomingChatMessage(msg) {
  // Save incoming messages from WebSocket (server echo) - only if we haven't saved them optimistically
  if (!msg?.clientMsgId || !seenClientMsgIds.has(msg.clientMsgId)) {
    await saveChatMessage(msg);
  }
}

async function openChatModal() {
  document.getElementById('chatModal').classList.add('show');

  try {
    if (pageInitPromise) await pageInitPromise;
  } catch (e) {
  }

  await loadChatHistory();
  initChat();
}

function closeChatModal() {
  document.getElementById('chatModal').classList.remove('show');
  if (chatChannel) {
    // Use global supabase instance
    try { window.supabase.removeChannel(chatChannel); } catch (e) {}
    chatChannel = null;
  }
}

function initChat() {
  if (chatChannel) return;
  if (!currentUser?.id) return;

  console.log('Subscribing to Supabase Realtime chat messages');
  // Use global supabase instance
  chatChannel = window.supabase
    .channel(`chat_messages_to_${currentUser.id}`)
    .on(
      'postgres_changes',
      {
        event: 'INSERT',
        schema: 'public',
        table: 'chat_messages',
        filter: `to_user_id=eq.${currentUser.id}`
      },
      (payload) => {
        const row = payload?.new;
        if (!row) return;

        const msg = {
          fromRole: row.from_role,
          fromUserId: row.from_user_id,
          toUserId: row.to_user_id,
          text: row.text,
          ts: row.ts,
          clientMsgId: row.client_msg_id || null
        };

        if (msg?.clientMsgId) {
          if (seenClientMsgIds.has(msg.clientMsgId)) return;
          seenClientMsgIds.add(msg.clientMsgId);
        }

        displayChatMessage(msg, true);
      }
    )
    .subscribe((status) => {
      console.log('Chat Realtime status:', status);
      if (status === 'CHANNEL_ERROR') {
        showToast('Chat connection error', 'error');
      }
    });
}

function initCreditsRealtime() {
  if (creditsChannel) return;
  if (!currentUser?.id) return;

  // Use global supabase instance
  creditsChannel = window.supabase
    .channel(`credits_${currentUser.id}`)
    .on(
      'postgres_changes',
      {
        event: 'UPDATE',
        schema: 'public',
        table: 'users',
        filter: `id=eq.${currentUser.id}`
      },
      (payload) => {
        const row = payload?.new;
        if (!row) return;
        const credits = Number(row.credits);
        if (!Number.isFinite(credits)) return;
        const el = document.getElementById('userCredits');
        if (el) el.textContent = `$${credits.toFixed(2)}`;
        showToast(`Credits updated: $${credits.toFixed(2)}`, 'success');
      }
    )
    .subscribe((status) => {
      console.log('Credits Realtime status:', status);
    });
}

function displayChatMessage(msg, skipPersist) {
  const container = document.getElementById('chatMessages');
  
  // Clear placeholder message on first real message
  const placeholder = container.querySelector('div[style*="text-align: center"]');
  if (placeholder) {
    placeholder.remove();
  }
  
  const messageDiv = document.createElement('div');
  messageDiv.className = `chat-message ${msg.fromRole}`;
  
  const bubble = document.createElement('div');
  bubble.className = 'chat-bubble';
  bubble.textContent = msg.text;
  
  const time = document.createElement('div');
  time.className = 'chat-time';
  time.textContent = new Date(msg.ts).toLocaleTimeString();
  
  messageDiv.appendChild(bubble);
  messageDiv.appendChild(time);
  container.appendChild(messageDiv);
  container.scrollTop = container.scrollHeight;

  if (!skipPersist) {
    // Only save if this is an optimistic render (not from server echo)
    if (msg.fromRole === 'user') {
      saveChatMessage(msg);
    }
  }
}

function sendChatMessage() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  
  console.log('Sending message:', text);
  console.log('Chat Realtime active:', !!chatChannel);
  
  if (!text) {
    console.log('No text to send');
    return;
  }
  
  const message = {
    type: 'chat_message',
    text: text,
    clientMsgId: `${Date.now()}-${Math.random().toString(16).slice(2)}`
  };
  
  console.log('Sending message:', message);
  
  try {
    if (message.clientMsgId) {
      seenClientMsgIds.add(message.clientMsgId);
    }
    
    // Display the message immediately for better UX
    displayChatMessage({
      fromRole: 'user',
      text: text,
      ts: Date.now(),
      clientMsgId: message.clientMsgId,
      toUserId: null // Will be set when admin responds
    });
    
    input.value = '';
  } catch (error) {
    console.error('Error sending message:', error);
    showToast('Failed to send message', 'error');
  }
}
</script>

  <!-- Chat Modal -->
  <div id="chatModal" class="modal">
    <div class="modal-card chat-modal">
      <div class="chat-header">
        <h3><i class="fas fa-comments"></i> Chat with Admin</h3>
        <div class="chat-header-actions">
          <button class="chat-help-btn" type="button" aria-label="How this works">
            <i class="fas fa-question"></i>
            <div class="chat-help-tooltip">Talk to the admin to request credits. You can send money via Baridi Mob or CCP, and the admin will add credits to your account.</div>
          </button>
          <button onclick="closeChatModal()" class="modal-close">&times;</button>
        </div>
      </div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input-area">
        <input type="text" id="chatInput" placeholder="Type your message..." onkeypress="if(event.key==='Enter') sendChatMessage()">
        <button onclick="sendChatMessage()" class="send-btn"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  </div>
</body>
</html>